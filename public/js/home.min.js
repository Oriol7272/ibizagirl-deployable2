(function(){
  console.log("üè† home.min.js cargado");
  var U=window.IBG_UTIL||{}, $=U.$;

  function startRotation(list){
    var bannerImg=document.querySelector('.banner .img'); if(!bannerImg) return;
    if(!list || !list.length){
      bannerImg.style.backgroundImage='url("decorative-images/paradise-beach.png")';
      bannerImg.style.opacity=.28; return;
    }
    var i=0; function rot(){
      bannerImg.style.opacity=0;
      var src=list[i%list.length];
      setTimeout(function(){
        bannerImg.style.backgroundImage='url("'+src+'")';
        bannerImg.style.opacity=.28;
      },220); i++;
    }
    rot(); setInterval(rot,4000);
  }

  function build(){
    var pub=window.CONTENT_PUBLIC||[];
    if(!Array.isArray(pub) || pub.length===0){
      console.warn("‚ö†Ô∏è CONTENT_PUBLIC sigue vac√≠o; no puedo construir carrusel/galer√≠a");
      return false;
    }
    // Carrusel 30
    var c30=(U.sample(pub,30)).map(function(x){return U.norm(x,'full')});
    var car=document.getElementById('carousel');
    if(car){
      car.innerHTML="";
      c30.forEach(function(src){
        var img=new Image(); img.loading="lazy"; img.decoding="async"; img.src=src; car.appendChild(img);
      });
      console.log("üé† Carrusel creado con", c30.length, "im√°genes");
    }
    // Grid 40
    var used=new Set(c30.map(String));
    var rest=pub.map(function(x){return U.norm(x,'full')}).filter(function(x){return !used.has(String(x))});
    var g40=U.sample(rest,40);
    var grid=document.getElementById('grid40');
    if(grid){
      grid.innerHTML="";
      g40.forEach(function(src){
        var d=document.createElement('div'); d.className='thumb';
        var img=new Image(); img.loading="lazy"; img.decoding="async"; img.src=src;
        d.appendChild(img); grid.appendChild(d);
      });
      console.log("üñºÔ∏è Galer√≠a creada con", g40.length, "im√°genes");
    }
    return true;
  }

  document.addEventListener('DOMContentLoaded',function(){
    console.log("üåÖ DOM listo; construyendo Home‚Ä¶");
    // Rotaci√≥n banner
    fetch('decorative-images/manifest.json').then(function(r){return r.ok?r.json():null}).then(function(j){
      var arr=j&&Array.isArray(j.images)?j.images:[]; var list=arr.map(function(n){return 'decorative-images/'+n});
      startRotation(list.length?list:['decorative-images/paradise-beach.png']);
    }).catch(function(){startRotation(['decorative-images/paradise-beach.png'])});

    // Asegurar que CONTENT_PUBLIC est√° disponible: reintentos durante 5s
    var tries=0, max=50;
    (function waitPublic(){
      if ((!Array.isArray(window.CONTENT_PUBLIC) || window.CONTENT_PUBLIC.length===0) && U.autodetectPublicDeep){
        U.autodetectPublicDeep();
      }
      if (build()){ return; }
      if (tries++<max){ return setTimeout(waitPublic,100); }
      console.warn("‚è±Ô∏è Timeout esperando CONTENT_PUBLIC");
    })();
  });
})();
