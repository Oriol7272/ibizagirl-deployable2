(()=>{const t=(...e)=>console.log("[IBG-Pay]",...e),a={key:"ibg_grants",get(){try{return JSON.parse(localStorage.getItem(this.key)||"[]")}catch{return[]}},set(e){localStorage.setItem(this.key,JSON.stringify(e))},add(e){if(!e)return;const r=this.get().filter(n=>n.exp>Date.now()/1e3);r.push(e),this.set(r)},hasValidForItem(e){const r=Math.floor(Date.now()/1e3),n=s=>atob(s.replace(/-/g,"+").replace(/_/g,"/"));for(const s of this.get()){const o=String(s).split(".");if(o.length!==3)continue;try{const i=JSON.parse(n(o[1]));if(i.typ==="grant"&&i.exp>r&&(i.scope==="all"||i.scope==="item"&&i.item===e))return!0}catch{}}return!1}},l={_sdkLoaded:!1,_currency:"EUR",async loadSdk(){if(this._sdkLoaded&&window.paypal)return window.paypal;const e=await fetch("/api/paypal/config").then(r=>r.json()).catch(()=>({ok:!1}));if(!(e!=null&&e.ok)||!e.clientId)throw new Error("paypal config");this._currency=e.currency||"EUR",await new Promise((r,n)=>{const s=document.createElement("script");s.src=`https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(e.clientId)}&currency=${this._currency}&intent=capture&components=buttons`,s.onload=r,s.onerror=n,document.head.appendChild(s)});return this._sdkLoaded=!0,window.paypal},async checkoutPpv(e){const r=await this.loadSdk();let n=document.getElementById("ibg-pay-modal");n?(n.style.display="flex",n.querySelector("#ibg-paypal-buttons").innerHTML=""):(n=document.createElement("div"),n.id="ibg-pay-modal",n.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:99999;",n.innerHTML='<div style="background:#111;padding:16px;border-radius:12px;max-width:420px;width:100%"><div id="ibg-paypal-buttons"></div><button id="ibg-pay-close" style="margin-top:12px;width:100%;padding:10px;border-radius:8px;background:#333;color:#fff;border:0">Cancelar</button></div>',document.body.appendChild(n),n.querySelector("#ibg-pay-close").onclick=()=>n.remove()),r.Buttons({style:{layout:"horizontal",color:"black",shape:"rect",label:"pay"},createOrder:async()=>{const o=await fetch("/api/paypal/create-order",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({sku:"ppv_1"})}),i=await o.json();if(!i.ok)throw new Error("create-order failed");return t("order CREATED",i.id),i.id},onApprove:async({orderID:o})=>{try{const i=await fetch("/api/paypal/capture",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({orderId:o,sku:"ppv_1",item:e})}),c=await i.json();if(!c.ok){console.error("capture error",c),alert("No se pudo capturar el pago.");return}t("capture COMPLETED",c),a.add(c.grant),document.querySelector(`[data-ibg-name="${CSS.escape(e)}"]`)?.classList.remove("ibg-locked"),n.remove(),alert("¡Pago completado! Acceso concedido durante 24h.")}catch(i){console.error("onApprove error",i),alert("Error durante la confirmación.")}},onError:o=>{console.error("PayPal Buttons error",o),alert("Error con PayPal.")}}).render("#ibg-paypal-buttons")},enableThumbHandlers(){document.addEventListener("click",e=>{let r=e.target.closest("[data-ibg-ppv]");let n=(r==null?void 0:r.getAttribute("data-ibg-ppv"))||null;if(!n){const s=e.target.closest('.ibg-ppv-btn,[data-ppv="1"]');if(s){const o=s.closest("[data-ibg-name]");n=(o==null?void 0:o.getAttribute("data-ibg-name"))||null,r=s}}if(!n)return;e.preventDefault(),this.checkoutPpv(n)})},markLockedThumbs(){document.querySelectorAll("[data-ibg-name]").forEach(e=>{const r=e.getAttribute("data-ibg-name");a.hasValidForItem(r)||e.classList.add("ibg-locked")})}};window.addEventListener("DOMContentLoaded",()=>{l.enableThumbHandlers(),l.markLockedThumbs()}),window.IBG_Payments=l;})();
