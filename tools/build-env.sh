#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "$0")/.." && pwd)"
mkdir -p "$ROOT/js"

PAYPAL_CLIENT_ID="${PAYPAL_CLIENT_ID:-}"
PAYPAL_SECRET="${PAYPAL_SECRET:-}"
PAYPAL_PLAN_MONTHLY="${PAYPAL_PLAN_MONTHLY_1499:-}"
PAYPAL_PLAN_YEARLY="${PAYPAL_PLAN_ANNUAL_4999:-}"
PAYPAL_WEBHOOK_ID="${PAYPAL_WEBHOOK_ID:-}"

EXOCLICK_ZONE="${EXOCLICK_ZONE:-}"
JUICYADS_ZONE="${JUICYADS_ZONE:-}"
EROADVERTISING_ZONE="${EROADVERTISING_ZONE:-}"
POPADS_SITE_ID="${POPADS_SITE_ID:-}"
POPADS_ENABLE="${POPADS_ENABLE:-}"

CRISP_WEBSITE_ID="${CRISP_WEBSITE_ID:-}"

IBG_ASSETS_BASE_URL="${IBG_ASSETS_BASE_URL:-}"

EXOCLICK_SNIPPET_B64="${EXOCLICK_SNIPPET_B64:-}"
JUICYADS_SNIPPET_B64="${JUICYADS_SNIPPET_B64:-}"
EROADVERTISING_SNIPPET_B64="${EROADVERTISING_SNIPPET_B64:-}"

ENVIRONMENT="${PUBLIC_ENVIRONMENT:-production}"
CURRENCY="${PUBLIC_CURRENCY:-EUR}"

b64d(){ [ -n "$1" ] && python3 - <<PY || true
import base64,sys;print(base64.b64decode(sys.argv[1]).decode("utf-8"), end="")
PY
}

gen() {
cat > "$1" <<EOT
export const ENV = {
  PAYPAL_CLIENT_ID: "${PAYPAL_CLIENT_ID}",
  PAYPAL_SECRET: "${PAYPAL_SECRET}",
  PAYPAL_PLAN_MONTHLY: "${PAYPAL_PLAN_MONTHLY}",
  PAYPAL_PLAN_YEARLY: "${PAYPAL_PLAN_YEARLY}",
  PAYPAL_WEBHOOK_ID: "${PAYPAL_WEBHOOK_ID}",

  EXOCLICK_ZONE_ID: "${EXOCLICK_ZONE}",
  JUICYADS_ZONE_ID: "${JUICYADS_ZONE}",
  EROADVERTISING_ZONE_ID: "${EROADVERTISING_ZONE}",
  POPADS_SITE_ID: "${POPADS_SITE_ID}",
  POPADS_ENABLE: "${POPADS_ENABLE}",

  CRISP_WEBSITE_ID: "${CRISP_WEBSITE_ID}",

  IBG_ASSETS_BASE_URL: "${IBG_ASSETS_BASE_URL}",

  EXOCLICK_SNIPPET: \`${b64d "$EXOCLICK_SNIPPET_B64"}\`,
  JUICYADS_SNIPPET: \`${b64d "$JUICYADS_SNIPPET_B64"}\`,
  EROADVERTISING_SNIPPET: \`${b64d "$EROADVERTISING_SNIPPET_B64"}\`,

  ENVIRONMENT: "${ENVIRONMENT}",
  CURRENCY: "${CURRENCY}"
};
if (typeof window !== "undefined") {
  window.ENV = ENV;
  window.PAYPAL_CLIENT_ID = ENV.PAYPAL_CLIENT_ID;
  window.PAYPAL_PLAN_MONTHLY = ENV.PAYPAL_PLAN_MONTHLY;
  window.PAYPAL_PLAN_YEARLY  = ENV.PAYPAL_PLAN_YEARLY;
  window.PAYPAL_WEBHOOK_ID = ENV.PAYPAL_WEBHOOK_ID;

  window.EXOCLICK_ZONE_ID = ENV.EXOCLICK_ZONE_ID;
  window.JUICYADS_ZONE_ID = ENV.JUICYADS_ZONE_ID;
  window.EROADVERTISING_ZONE_ID = ENV.EROADVERTISING_ZONE_ID;
  window.POPADS_SITE_ID = ENV.POPADS_SITE_ID;
  window.POPADS_ENABLE = ENV.POPADS_ENABLE;

  window.CRISP_WEBSITE_ID = ENV.CRISP_WEBSITE_ID;
  window.IBG_ASSETS_BASE_URL = ENV.IBG_ASSETS_BASE_URL;

  window.EXOCLICK_SNIPPET = ENV.EXOCLICK_SNIPPET;
  window.JUICYADS_SNIPPET = ENV.JUICYADS_SNIPPET;
  window.EROADVERTISING_SNIPPET = ENV.EROADVERTISING_SNIPPET;
}
EOT
}

gen "$ROOT/js/env.js"
gen "$ROOT/env.js"
echo "env.js listo"
